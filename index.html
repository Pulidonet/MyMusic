<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Emisora Escolar - Juventud Est茅reo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="cssestilos.css">
</head>
<body>
  <nav>
    <ul>
      <li><a href="#inicio">Inicio</a></li>
      <li><a href="#solicitudes">Solicitar Canci贸n</a></li>
      <li><a href="#editor">Editor Musical</a></li>
    </ul>
  </nav>

  <header id="inicio">
    <div class="titulo-con-imagen">
      <img src="img/imagenlogo.png" alt="Logo IED Rep煤blica de China" class="logo-colegio">
      <img src="img/audifonos.jpg" alt="Estudiantes con aud铆fonos" class="imagen-audifonos">
    </div>
    <h1>EMISORA ESCOLAR "JUVENTUD ESTREO"</h1>
    <p class="subtitulo">Bienvenidos a la emisora escolar de la Instituci贸n Educativa Distrital Rep煤blica de China.</p>
  </header>

  <main>
    <section class="bienvenida">
      <h2>Bienvenid@s</h2>
      <p>
        Aqu铆 los estudiantes pueden solicitar sus canciones y disfrutar de una programaci贸n pensada para toda la comunidad educativa.
      </p>
    </section>

    <section class="formulario" id="solicitudes">
      <h2>隆Solicita tu canci贸n favorita!</h2>
      <form action="http://localhost:8080" method="post">
        <label for="email">Correo electr贸nico:</label>
        <input type="email" id="email" name="email" placeholder="ejemplo@correo.com" required>

        <label for="comentario">Comentario o canci贸n:</label>
        <textarea id="comentario" name="comentario" rows="4" placeholder="Este espacio est谩 dise帽ado para que solicites tu canci贸n favorita" required></textarea>

        <button type="submit">Enviar</button>
      </form>
    </section>

    <section class="editor-audio" id="editor">
      <h2> Editor de Audio Escolar</h2>
      <input type="file" id="audioFile" accept="audio/*"><br><br>
      <audio id="audioPlayer" controls></audio><br><br>

      <label>Inicio (segundos): <input type="number" id="startTime" min="0" value="0"></label>
      <label>Fin (segundos): <input type="number" id="endTime" min="0" value="10"></label><br><br>

      <button onclick="recortarYDescargar()">Recortar con Fade y Descargar</button>
    </section>
  </main>

  <footer>
    <p>Derechos reservados 漏 2025 IED Rep煤blica de China</p>
    <p>Desarrollado por BLUME</p>
  </footer>

  <script>
    document.querySelector("form").addEventListener("submit", function(e) {
      const email = document.getElementById("email").value.trim();
      const comentario = document.getElementById("comentario").value.trim();
      if (!email || !comentario) {
        alert("Por favor completa todos los campos.");
        e.preventDefault();
      }
    });

    const audioFileInput = document.getElementById("audioFile");
    const audioPlayer = document.getElementById("audioPlayer");
    let audioBuffer = null;

    audioFileInput.addEventListener("change", function () {
      const file = this.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const context = new AudioContext();
        context.decodeAudioData(e.target.result, function (buffer) {
          audioBuffer = buffer;
          const url = URL.createObjectURL(file);
          audioPlayer.src = url;
        });
      };
      reader.readAsArrayBuffer(file);
    });

    function recortarYDescargar() {
      if (!audioBuffer) {
        alert("Primero sube un archivo de audio.");
        return;
      }

      const start = parseFloat(document.getElementById("startTime").value);
      const end = parseFloat(document.getElementById("endTime").value);
      const duration = end - start;

      if (isNaN(start) || isNaN(end) || start >= end || end > audioBuffer.duration) {
        alert("Verifica los tiempos de inicio y fin.");
        return;
      }

      const context = new AudioContext();
      const sampleRate = audioBuffer.sampleRate;
      const length = Math.floor(duration * sampleRate);
      const newBuffer = context.createBuffer(audioBuffer.numberOfChannels, length, sampleRate);

      for (let channel = 0; channel < audioBuffer.numberOfChannels; channel++) {
        const oldData = audioBuffer.getChannelData(channel);
        const newData = newBuffer.getChannelData(channel);
        const startSample = Math.floor(start * sampleRate);

        for (let i = 0; i < length; i++) {
          let sample = oldData[startSample + i];
          const fadeIn = Math.min(1, i / (sampleRate * 1));
          const fadeOut = Math.min(1, (length - i) / (sampleRate * 1));
          sample *= Math.min(fadeIn, fadeOut);
          newData[i] = sample;
        }
      }

      exportWAV(newBuffer, sampleRate);
    }

    function exportWAV(buffer, sampleRate) {
      const numChannels = buffer.numberOfChannels;
      const length = buffer.length * numChannels * 2;
      const wavBuffer = new ArrayBuffer(44 + length);
      const view = new DataView(wavBuffer);

      function writeString(view, offset, string) {
        for (let i = 0; i < string.length; i++) {
          view.setUint8(offset + i, string.charCodeAt(i));
        }
      }

      let offset = 0;
      writeString(view, offset, "RIFF"); offset += 4;
      view.setUint32(offset, 36 + length, true); offset += 4;
      writeString(view, offset, "WAVE"); offset += 4;
      writeString(view, offset, "fmt "); offset += 4;
      view.setUint32(offset, 16, true); offset += 4;
      view.setUint16(offset, 1, true); offset += 2;
      view.setUint16(offset, numChannels, true); offset += 2;
      view.setUint32(offset, sampleRate, true); offset += 4;
      view.setUint32(offset, sampleRate * numChannels * 2, true); offset += 4;
      view.setUint16(offset, numChannels * 2, true); offset += 2;
      view.setUint16(offset, 16, true); offset += 2;
      writeString(view, offset, "data"); offset += 4;
      view.setUint32(offset, length, true); offset += 4;

      for (let i = 0; i < buffer.length; i++) {
        for (let channel = 0; channel < numChannels; channel++) {
          const sample = buffer.getChannelData(channel)[i];
          const s = Math.max(-1, Math.min(1, sample));
          view.setInt16(offset, s * 0x7FFF, true);
          offset += 2;
        }
      }

      const blob = new Blob([view], { type: "audio/wav" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "recorte.wav";
      a.click();
    }
  </script>
</body>
</html>
